# 地震数据解析页面

[TOC]

##  前言 

- 将`SEGY`数据写入服务器，进行今解析

- `SeismicAnalysi.vue`
- `SeismicFileRead`





## 1. 后端

### 1.1 服务器文件表格展示

- 将服务器中文件返回前端表格展示

- `views.py`

  ```python
  # 地震数据解析，获取文件
  @require_http_methods(['GET'])
  def SeismicFileRead(request):
  
      # base_dir = 'c:/'
      base_dir = "././pic/"
      list = os.listdir(base_dir)
  
      filelist = []
      for i in range(0, len(list)):
          path = os.path.join(base_dir, list[i])
          if os.path.isfile(path):
              filelist.append(list[i])
      list_db = []
      content = {}
      for i in range(0, len(filelist)):
          path = os.path.join(base_dir, filelist[i])
          if os.path.isdir(path):
              continue
          # 获取文件的修改时间
          timestamp = os.path.getmtime(path)
          # print(timestamp)
          # 获取文件的修改时间
          # ts1 = os.stat(path).st_mtime
          # print(ts1)
          # 获取文件的大小,结果保留两位小数，单位为MB
          filesize = os.path.getsize(path)
          fsize = filesize/float(1024*1024)
          size = round(fsize, 2)
          filesize = str(size) + 'MB'
          # print(size)
  
          date = datetime.datetime.fromtimestamp(timestamp)
          upload_time = date.strftime('%Y-%m-%d %H:%M:%S')
          # upload_time = date.strftime('%Y-%m-%d')
          # print(list[i], ' 最近修改时间是: ', date.strftime('%Y-%m-%d %H:%M:%S'))
  
          fileinfo = {
              'filename': list[i],
              'filesize': filesize,
              'upload_time': upload_time,
          }
          # print(type(fileinfo))
          # json_str = str(fileinfo)
          # print(type(json_str))
          list_db.append(fileinfo)
          content = json.dumps(list_db)    #这个地方要用字符串传到前端去
      print(content)
      print(type(content))
      return HttpResponse(content, "application/json")
  ```

  

### 1.2 服务器文件删除

- `views.py`

  ```python
  # 地震数据解析，删除服务器文件
  @require_http_methods(['POST'])
  def SeismicAnalysisDelete(request):
      # filename1 = request.POST
      # print(filename1)
      filename = request.POST.get('filename')
      print(filename)
      content = "..\mongeostore_env\pic\\" + filename
      os.remove(content)
      return HttpResponse('success')
  ```

  

### 1.3 解析数据

- `views.py`

  ```python
  # 地震数据解析，获取服务器文件
  @require_http_methods(['GET'])
  def SeismicFileRead(request):
  
      # base_dir = 'c:/'
      base_dir = "././pic/"
      list = os.listdir(base_dir)
  
      filelist = []
      for i in range(0, len(list)):
          path = os.path.join(base_dir, list[i])
          if os.path.isfile(path):
              filelist.append(list[i])
      list_db = []
      content = {}
      for i in range(0, len(filelist)):
          path = os.path.join(base_dir, filelist[i])
          if os.path.isdir(path):
              continue
          # 获取文件的修改时间
          timestamp = os.path.getmtime(path)
          # print(timestamp)
          # 获取文件的修改时间
          # ts1 = os.stat(path).st_mtime
          # print(ts1)
          # 获取文件的大小,结果保留两位小数，单位为MB
          filesize = os.path.getsize(path)
          fsize = filesize/float(1024*1024)
          size = round(fsize, 2)
          filesize = str(size) + 'MB'
          # print(size)
  
          date = datetime.datetime.fromtimestamp(timestamp)
          upload_time = date.strftime('%Y-%m-%d %H:%M:%S')
          # upload_time = date.strftime('%Y-%m-%d')
          # print(list[i], ' 最近修改时间是: ', date.strftime('%Y-%m-%d %H:%M:%S'))
  
          fileinfo = {
              'filename': list[i],
              'filesize': filesize,
              'upload_time': upload_time,
          }
          # print(type(fileinfo))
          # json_str = str(fileinfo)
          # print(type(json_str))
          list_db.append(fileinfo)
          content = json.dumps(list_db)  # 这个地方要用字符串传到前端去
      # print(content)
      # print(type(content))
      return HttpResponse(content, "application/json")
  
  
  # 地震数据解析，获取服务器文件
  @require_http_methods(['GET'])
  def SeismicHeaderQuery(request):
      print(request.GET)
      filename = request.GET.get('filename')
      filequery = request.GET.get('queryparams')
      # print(filename)
      content = "..\mongeostore_env\pic\\" + filename
  
      try:
          with segyio.open(content, mode="r", strict=False, ignore_geometry=False, endian='big') as f:
              if filequery == 'header':
                  datatest = f.header[0]
                  queryinfo = str(datatest)
                  return HttpResponse(queryinfo)
              elif filequery == 'Bin':
                  datatest = f.bin
                  queryinfo = str(datatest)
                  return HttpResponse(queryinfo)
              elif filequery == 'track':
                  datatest = f.text
                  queryinfo = str(datatest)
                  return HttpResponse(queryinfo)
              elif filequery == 'traces':
                  datatest = f.trace
                  queryinfo = str(datatest)
                  return HttpResponse(queryinfo)
              elif filequery == 'trace1':
                  datatest = f.trace[0]  # 拿到segy中数据
                  queryinfo = str(datatest)
                  return HttpResponse(queryinfo)
              elif filequery == 'trace_1':
                  datatest = f.trace[-1]
  
                  # print(str(datatest))
                  queryinfo = str(datatest)
                  return HttpResponse(queryinfo)
              else:
                  datatest = f.trace[int(filequery)]
                  # print(filequery)
                  # print(type(filequery))
                  # print(datatest)
                  queryinfo = str(datatest)
                  return HttpResponse(queryinfo)
      except:
          print('解析错误')
          return HttpResponse('err')
  ```



### 1.4 上传数据

- `views.py`

  ```python
  # 地震数据解析，本地文件上传服务器
  class SeismicAnalysisUpload(APIView):
      def get(self, request, *args, **kwargs):
          """
          docstring
          """
          # print("走的是GET方法")
          response = {}
          response['code'] = 200
          # response["Access-Control-Allow-Methods"] = "POST"
          return HttpResponse(json.dumps(response), content_type="application/json")
  
      def post(self, request):
          File = request.FILES.get("file", None)
          # filename = request.POST.get('filename')
          # 保存到本地
          if not os.path.exists('pic/'):
              os.mkdir('pic/')
          with open("./pic/%s" % File.name, 'wb+') as f:
              for chunk in File.chunks():
                  f.write(chunk)
              f.close()
          return HttpResponse('success')
  ```

  

### 1.5 云端数据

- 这部分在使用进度条时，想使用前端定时器的方式，但后端获取实时下载百分比返回给前端，交互比较不理性；故而采用后端使用`WebSocket`通信；完成这部分先看下一节；

- `views.py`

  ```python
  # 地震数据解析，下载云端数据
  # @require_http_methods(['GET'])
  @accept_websocket
  def AnalysisCloudDown(request):
  
      if request.is_websocket():  # 如果请求是websocket请求：
  
          WebSocket = request.websocket
          print(WebSocket)
          i = 0  # 设置发送至前端的次数
          messages = {}
  
          while True:
              i += 1  # 递增次数 i
              time.sleep(1)  # 休眠1秒
  
              # 判断是否通过websocket接收到数据
              if WebSocket.has_messages():
  
                  # 存在Websocket客户端发送过来的消息
                  client_msg = WebSocket.read().decode()
                  print(client_msg)
                  # # 从数据库拿到数据
                  seismic_obj = SeismicInfo.objects(id=client_msg).first()
                  filename = seismic_obj.seismic_filename
                  seismic_file = seismic_obj.filedata.read  # 注意这个地方不用加（）
                  seismic_filensize = seismic_obj.filedata.length
                  content_type = seismic_obj.filedata.content_type
                  filename = filename + '.' + content_type
                  # 数据写入服务器
                  RECORD_SIZE = 1024*40  # 单位是B
                  with open("../mongeostore_env/pic/%s" % filename, 'wb') as f:
                      # f.write(seismic_file)
                      # print(f.tell())
                      # print('save success')
                      records = iter(partial(seismic_file, RECORD_SIZE), b'')
                      for r in records:
                          f.write(r)
                          percent = int(f.tell()*100/seismic_filensize)
                          # print(percent)
                          # print(percent)
                          # print(f.tell())
                          # return HttpResponse(percent)
  
                          # 设置发送前端的数据
                          messages = {
                              # 'time': time.strftime('%Y.%m.%d %H:%M:%S', time.localtime(time.time())),
                              # 'server_msg': 'send %d times!' % i,
                              'client_msg': client_msg,
                              'percent': percent
                          }
                          request.websocket.send(json.dumps(messages))
              # else:
              #     # 设置发送前端的数据
              #     messages = {
              #         'time': time.strftime('%Y.%m.%d %H:%M:%S', time.localtime(time.time())),
              #         'server_msg': 'send %d times!' % i,
              #     }
  
              #     # 设置发送数据为json格式
              #     request.websocket.send(json.dumps(messages))
      else:
          try:#如果是普通的http方法
              message = request.GET['message']
              return HttpResponse(message)
          except:
              # return render(request,'index.html')
              return HttpResponse('test123')
  
  ```

  - [进度条](https://blog.csdn.net/WDCCSDN/article/details/89395287)
  - [Django进度条](https://blog.csdn.net/chaoren499/article/details/97135142)
  - [python](https://www.jianshu.com/p/b0a07bd72fb8)

- 这里涉及到进度条更新问题，看了相关文章，决定尝试采用`dwebsocket`



### 1.6 `urls.py`

- urls.py

  ```python
  urlpatterns = [
      path('', include(router.urls)),
      path('seismicinfo/', SeismicInfoView.as_view(),
           name='seismicinfo'),  # 地震元数据查询上传
      path('editseismicinfo/', views.EditSeismicInfo,
           name="editseismicinfo"),  # 地震元数据编辑
      path('deleteseismicinfo/', views.DeleteSeismicInfo,
           name="deleteseismicinfo"),  # 地震元数据删除
      path('seismicinfosearch/', SeismicInfoSearch.as_view(),
           name="seismicinfosearch"),  # 地震元数据查询
      path('seismicfiledownload/', views.SeismicFileDownload,
           name="seismicfiledownload"),  # 地震元数据删除
      path('seismicfileread/', views.SeismicFileRead,
           name="seismicfileread"),  # 地震数据解析，获取文件
      path('seismicheaderquery/', views.SeismicHeaderQuery,
           name="seismicheaderquery"),  # 地震数据解析，获取文件
      path('Seismicanalysisdelete/', views.SeismicAnalysisDelete,
           name="Seismicanalysisdelete"),  # 地震数据解析，删除文件
      path('seismicanalysisupload/', SeismicAnalysisUpload.as_view(),
           name="seismicanalysisupload"),  # 地震数据解析，上传本地文件
      path('analysisclouddown/', views.AnalysisCloudDown,
           name="analysisclouddown"),  # 地震数据解析，下载数据库云端数据
  
  ]
  ```

  

## 2. 前端

- `SeismicAnalysi.vue`

  ```vue
  <!--
   * @Description: henggao_learning
   * @version: v1.0.0
   * @Author: henggao
   * @Date: 2020-12-17 22:25:22
   * @LastEditors: henggao
   * @LastEditTime: 2020-12-22 22:19:59
  -->
  <template>
    <el-container>
      <el-header>
        <h2
          style="
            font-size: 30px;
            padding-top: 10px;
            color: #870000;
            min-width: 1100px;
            overflow: hidden;
            text-align: left;
          "
        >
          <i class="el-icon-caret-right" /> 地震数据解析
        </h2></el-header
      >
      <el-container>
        <div class="left_aside" style="width: 500px; height: 750px">
          <el-card shadow="hover" style="">
            <div class="mian_file_title" style="text-align: left; height: 50px">
              <h5 style="color: #810000">
                <i class="el-icon-document-checked"></i> 当前可以解析的数据如下：
              </h5>
            </div>
            <div class="main_file_button" style="text-align: left; display: flex">
              <h5 style="padding-top: 6px; color: #810000">选择：</h5>
              <el-button
                type="goon"
                size="medium"
                plain
                @click="centerDialogVisible = true"
                >上传数据</el-button
              ><el-button
                type="goon"
                size="medium"
                plain
                @click="cloudDialogVisible = true"
                >云端数据</el-button
              >
              <el-button type="goon" size="medium" plain @click="refreshtable"
                >刷新表格</el-button
              >
            </div>
            <div>
              <el-table
                :data="
                  tableData.filter(
                    (data) =>
                      !search ||
                      data.filename.toLowerCase().includes(search.toLowerCase())
                  )
                "
                height="620"
                style="width: 100%"
              >
                <el-table-column type="expand">
                  <template slot-scope="props">
                    <el-form
                      label-position="left"
                      inline
                      class="demo-table-expand"
                    >
                      <el-form-item label="文件名称">
                        <span>{{ props.row.filename }}</span>
                      </el-form-item>
                      <el-form-item label="文件大小">
                        <span>{{ props.row.filesize }}</span>
                      </el-form-item>
                      <el-form-item label="修改时间">
                        <span>{{ props.row.upload_time }}</span>
                      </el-form-item>
                    </el-form>
                  </template>
                </el-table-column>
                <el-table-column type="index" width="45"> </el-table-column>
                <el-table-column label="文件名" prop="filename">
                </el-table-column>
  
                <el-table-column align="right">
                  <template slot="header" slot-scope="{}">
                    <el-input
                      v-model="search"
                      size="small"
                      placeholder="输入关键字搜索"
                    />
                  </template>
                  <template slot-scope="scope">
                    <el-button
                      size="mini"
                      type="danger"
                      plain
                      @click="handleDelete(scope.$index, tableData, scope.row)"
                      >删除</el-button
                    >
                    <el-button
                      size="mini"
                      type="primary"
                      plain
                      @click="seismicanalysic(scope.$index, tableData, scope.row)"
                      >解析</el-button
                    >
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </el-card>
        </div>
  
        <div style="height: 600px; width: 835px; min-width: 820px">
          <el-card shadow="hover" style="height: 750px">
            <div>
              <h5 style="color: #810000; text-align: left">
                <i class="el-icon-video-play"></i> 正在解析数据：{{
                  seismic_message
                }}
              </h5>
            </div>
            <div class="analysis_content" style="height: 700px; overflow: auto">
              <pre>{{ seismic_info }}</pre>
            </div>
          </el-card>
        </div>
        <div style="height: 600px; width: 300px">
          <el-card shadow="hover" style="height: 750px">
            <div>
              <h5 style="color: #810000; text-align: left">
                <i class="el-icon-setting"></i> 解析数据工具：
              </h5>
            </div>
            <div style="text-align: left; display: flex">
              <el-button
                type="goon"
                size="medium"
                plain
                @click="queryHeader((val = 'header'))"
                >卷头</el-button
              >
              <el-button
                type="goon"
                size="medium"
                plain
                @click="queryHeader((val = 'track'))"
                >道头</el-button
              >
              <el-button
                type="goon"
                size="medium"
                plain
                @click="queryHeader((val = 'traces'))"
                >Traces</el-button
              >
            </div>
            <div style="text-align: left; display: flex; padding-top: 5px">
              <el-button
                type="goon"
                size="medium"
                plain
                @click="queryHeader((val = 'Bin'))"
                >Bin</el-button
              >
              <el-button
                type="goon"
                size="medium"
                plain
                @click="queryHeader((val = 'trace1'))"
                >第一道</el-button
              >
              <el-button
                type="goon"
                size="medium"
                plain
                @click="queryHeader((val = 'trace_1'))"
                >最后一道</el-button
              >
            </div>
            <div style="padding-top: 5px">
              <el-form
                ref="seismicform"
                :model="seismicform"
                :rules="seismicformrules"
                style="
                  display: flex;
                  height: 40px;
                  width: 240px;
                  background: #51abce;
                  border-radius: 5px;
                "
              >
                <el-form-item
                  label-width="70px"
                  label="第N道"
                  style="
                    width: 165px;
                    background: #51abce;
                    height: 40px;
                    border-radius: 5px;
                  "
                >
                  <el-input
                    v-model="seismicform.trace"
                    placeholder="0-n"
                    @keyup.enter.native="queryHeader((val = seismicform.trace))"
                  ></el-input>
                </el-form-item>
                <el-form-item style="width: 50px">
                  <el-button
                    type="goon"
                    @click="queryHeader((val = seismicform.trace))"
                    >查询</el-button
                  >
                </el-form-item>
              </el-form>
            </div>
          </el-card>
        </div>
        <el-dialog
          title="请上传需要解析的文件"
          :visible.sync="centerDialogVisible"
          width="30%"
          center
        >
          <AnalysisUploadFile />
  
          <span slot="footer" class="dialog-footer">
            <el-button @click="centerDialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="makesuretable">确 定</el-button>
          </span>
        </el-dialog>
        <el-dialog
          title="请上传需要解析的文件"
          :visible.sync="cloudDialogVisible"
          width="30%"
          style="min-width: 500px"
          center
        >
          <AnalysisCloudData ref="analysisCloudData" />
  
          <span slot="footer" class="dialog-footer">
            <el-button @click="cloudDialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="makesuretable2">确 定</el-button>
          </span>
        </el-dialog>
      </el-container>
    </el-container>
  </template>
  
  <script>
  import axios from "axios";
  import qs from "qs";
  import plupload from "plupload";
  import { stringify } from "qs";
  import AnalysisUploadFile from "@/components/seismic/AnalysisUploadFile.vue";
  import AnalysisCloudData from "@/components/seismic/AnalysisCloudData.vue";
  export default {
    name: "SeismicAnalysis",
    components: {
      AnalysisUploadFile,
      AnalysisCloudData,
    },
    data() {
      // 校验表单trace
      var checkTrace = (rule, value, callback) => {
        if (!value) {
          return callback(new Error("Trace不能为空"));
        }
        setTimeout(() => {
          var re = /^[0-9]*/; //判断字符串是否为数字
          if (!re.test(value)) {
            callback(new Error("请输入数字值"));
          } else {
            callback();
          }
        }, 500);
      };
      return {
        tableData: [
          {
            filename: "LX_SEGY001",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY002",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY003",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY004",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY005",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY006",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY007",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY008",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY009",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY010",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
          {
            filename: "LX_SEGY011",
            filesize: "1.24G",
            upload_time: "2018-12-1",
          },
        ],
        search: "", //搜索框
        seismic_message: "LX_SEGY001", //文件名称
        seismic_info: "", //地震解析数据
        // 表单数据
        seismicform: {
          trace: "",
        },
        // 校验表单数据
        seismicformrules: {
          trace: [{ validator: checkTrace, trigger: "blur" }],
        },
        // 上传弹出框
        centerDialogVisible: false,
        cloudDialogVisible: false,
      };
    },
    created() {
      this.showSeismicFile();
    },
  
    methods: {
      // 展示文件夹数据
      showSeismicFile() {
        let this_url = "http://127.0.0.1:8000/seismic/seismicfileread/";
        axios({ method: "GET", url: this_url, params: {} })
          .then((res) => {
            // console.log(res);
            // console.log(res.data);
            this.tableData = res.data;
            // 设置默认解析文件，这里社第一个文件
            let temp_data = res.data[0];
            this.seismic_message = temp_data["filename"];
          })
          .catch((err) => {
            console.log(err);
          });
      },
      // 删除文件
      handleDelete(index, rows, row) {
        // console.log(index, rows, row);
        // console.log(row.filename);
  
        // let json_data = JSON.stringify(row);
        let data = { filename: row.filename };
        rows.splice(index, 1);
        let this_url = "http://127.0.0.1:8000/seismic/Seismicanalysisdelete/";
        axios({
          method: "POST",
          url: this_url,
          data: qs.stringify(data),
          // data: {json_data} ,
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          // headers: { "Content-Type": "application/json" },
        })
          .then((res) => {
            // console.log("success");
          })
          .catch((err) => {
            console.log("err");
          });
      },
      // 解析文件
      seismicanalysic(index, rows, row) {
        console.log(index, row);
        console.log(row.filename);
        this.seismic_message = row.filename;
      },
      // 查询卷头信息
      queryHeader(val) {
        console.log(this.seismic_message);
        console.log(val);
        let this_url = "http://127.0.0.1:8000/seismic/seismicheaderquery/";
        axios({
          method: "GET",
          url: this_url,
          params: { filename: this.seismic_message, queryparams: val },
        })
          .then((res) => {
            // console.log(res);
            // console.log(res.data);
            // console.log(this.val);
            if (this.val == "header" || this.val == "Bin") {
              // console.log("yes");
              let jsondata = eval("(" + res.data + ")");
              // console.log(jsondata);
              // this.seismic_info = res.data;
              this.seismic_info = jsondata;
            } else {
              // console.log("no");
              this.seismic_info = res.data;
            }
          })
          .catch((err) => {
            // console.log(err);
            this.$message.error("Sorry，文件无法解析，请检查文件正确性！");
          });
      },
      // 上传服务器文件
      // 确定按钮
      makesuretable() {
        this.centerDialogVisible = false;
        this.cloudDialogVisible = false;
  
        this.showSeismicFile();
      },
      makesuretable2() {
        // this.$refs.analysisCloudData.WebSocketClose();
        this.centerDialogVisible = false;
        this.cloudDialogVisible = false;
  
        this.showSeismicFile();
      },
      // 刷新表格
      refreshtable() {
        this.showSeismicFile();
      },
    },
  };
  </script>
  
  <style lang='scss' scoped>
  // 按钮样式
  .el-button--goon.is-active,
  .el-button--goon:active {
    background: #51abce;
    border-color: #20b2aa;
    color: #fff;
  }
  
  .el-button--goon:focus,
  .el-button--goon:hover {
    background: #48d1cc;
    border-color: #48d1cc;
    color: #fff;
  }
  
  .el-button--goon {
    color: #fff;
    background-color: #51abce;
    border-color: #20b2aa;
  }
  
  //表格滚动条的宽度
  ::v-deep .el-table__body-wrapper::-webkit-scrollbar {
    width: 6px; // 横向滚动条
  
    height: 6px; // 纵向滚动条 必写
  }
  
  // 表格滚动条的滑块
  ::v-deep .el-table__body-wrapper::-webkit-scrollbar-thumb {
    background-color: rgba(119, 158, 194, 0.829);
  
    border-radius: 3px;
  }
  // 表格样式
  ::v-deep .demo-table-expand {
    font-size: 0;
  }
  ::v-deep .demo-table-expand label {
    width: 90px;
    color: #99a9bf;
  }
  ::v-deep .demo-table-expand .el-form-item {
    margin-right: 0;
    margin-bottom: 0;
    width: 80%;
  }
  // 主要内容滚动条
  .analysis_content::-webkit-scrollbar {
    width: 6px; // 横向滚动条
  
    height: 6px; // 纵向滚动条 必写
  }
  .analysis_content::-webkit-scrollbar-thumb {
    background-color: rgba(119, 158, 194, 0.829);
  
    border-radius: 3px;
  }
  
  // 解析工具表单
  // 表单label
  ::v-deep .el-form-item__label {
    color: #ffffff;
    // padding: 0;
  }
  // 按钮位置
  // ::v-deep .el-form-item__content {
  //   margin-left: 10px;
  // }
  ::v-deep .el-form-item__content {
    margin-left: 5px;
  }
  </style>
  ```


- `AnalysisUploadFile.vue`

  ```vue
  <!--
   * @Description: henggao_learning
   * @version: v1.0.0
   * @Author: henggao
   * @Date: 2020-12-21 17:08:19
   * @LastEditors: henggao
   * @LastEditTime: 2020-12-21 17:15:54
  -->
  <template>
    <div style="padding-top: 20px">
      <el-row>
        <el-col :span="14" class="upload-title"><h4>文件选择</h4></el-col>
        <el-col :span="10" style="display: flex"
          ><el-button ref="VideoChose" id="VideoChose" size="medium "
            >选择文件</el-button
          >
          <el-button
            ref="VideoChose"
            type="primary"
            size="medium  "
            @click="FileUplodeOn"
            >开始上传</el-button
          ></el-col
        >
      </el-row>
  
      <el-card style="margin-top: 20px">
        <el-table :data="fileList" style="width: 100%">
          <!-- <el-table-column prop="id" label="文件id"></el-table-column> -->
          <el-table-column prop="name" label="文件名称"></el-table-column>
          <!-- <el-table-column prop="type" label="文件类型"></el-table-column> -->
          <el-table-column prop="size" label="文件大小" v-slot="{ row }">
            {{ row.size }}MB
          </el-table-column>
          <el-table-column prop="upload_date" label="上传时间"></el-table-column>
          <!-- <el-table-column prop="publisher" label="上传人员"></el-table-column> -->
          <el-table-column label="进度" v-slot="{ row }">
            <el-progress
              :text-inside="true"
              :stroke-width="16"
              :percentage="row.percentage"
            ></el-progress>
          </el-table-column>
          <el-table-column label="取消上传" v-slot="{ row }">
            <el-button
              type="danger"
              icon="el-icon-delete"
              size="mini"
              circle
              @click="removeFile(row.id)"
            ></el-button>
          </el-table-column>
          <el-table-column label="上传状态" v-slot="{ row }">
            <el-link
              :type="
                row.loadType == 0
                  ? 'info'
                  : row.loadType == 1
                  ? 'warning'
                  : row.loadType == 2
                  ? 'success'
                  : 'danger'
              "
              :underline="false"
              >{{
                row.loadType == 0
                  ? "等待上传"
                  : row.loadType == 1
                  ? "正在上传"
                  : row.loadType == 2
                  ? "上传成功"
                  : "上传失败"
              }}</el-link
            >
          </el-table-column>
        </el-table>
      </el-card>
    </div>
  </template>
  
  <script>
  import plupload from "plupload";
  import axios from "axios";
  import { stringify } from "qs";
  export default {
    name: "UploadFile",
    data() {
      return {
        show: false,
        fileList: [],
        fileOptions: {
          browse_button: "VideoChose",
          // url: "http://127.0.0.1:8000/load/uploadfile/",
          url: "http://127.0.0.1:8000/seismic/seismicanalysisupload/",
          flash_swf_url: "script/Moxie.swf",
          silverlight_xap_url: "script/Moxie.xap",
          // chunk_size: "10mb", //分块大小  ,注销掉或者改chunk_size：'0mb'为解决文件大于10M存为blob问题
          max_retries: 3,
          unique_names: true,
          multi_selection: true,
          views: {
            list: true,
            thumbs: true, // Show thumbs
            active: "thumbs",
          },
          filters: {
            mime_types: [
              //文件格式
              {
                title: "files",
                extensions: "sgy,segy", //文件格式
              },
            ],
            max_file_size: "10240mb", //最大上传的文件
            prevent_duplicates: true, //不允许选取重复文件
          },
          multipart_params: {
            uuid: "", //参数
            // testparams: "Must can see me",
            // "testparams2": "Must can see me2"
          },
        },
      };
    },
  
    mounted() {
      //实例化一个plupload上传对象
      this.uploader.init();
      //绑定进队列
      this.uploader.bind("FilesAdded", this.FilesAdded);
      //绑定进度
      this.uploader.bind("UploadProgress", this.UploadProgress);
      //上传之前
      this.uploader.bind("BeforeUpload", this.BeforeUpload);
      //上传成功监听
      this.uploader.bind("FileUploaded", this.FileUploaded);
      //获取uuid
      // let url = `http://127.0.0.1:8000/api/uploadinfo/`;
      let url = `http://127.0.0.1:8000/seismic/seismicanalysisupload/`;
      axios.get(url).then(({ data }) => {
        this.fileOptions.multipart_params.uuid = data;
      });
    },
    computed: {
      //实例化一个plupload上传对象
      uploader() {
        return new plupload.Uploader(this.fileOptions);
      },
    },
    methods: {
      //绑定进队列
      FilesAdded(uploader, files) {
        let objarr = files.map((val, ind) => {
          let obj = {};
          obj.id = val.id;
          obj.name = val.name;
          obj.type = val.type;
          // obj.upload_date = val.upload_date;
          obj.upload_date = new Date().toLocaleString(); //获取日期与时间
          // obj.publiser = val.publiser;
          obj.publisher = "publisher"; //获取当前登录用户信息
          obj.size = parseInt((val.origSize / 1024 / 1024) * 100) / 100;
          obj.percentage = 0;
          obj.loadType = 0;
          console.log(obj);
          return obj;
        });
        this.fileList.push(...objarr);
      },
      //上传之前回调
      BeforeUpload(uploader, file) {
        this.fileList = this.fileList.map((val, ind) => {
          if (val.id == file.id) {
            val.loadType = 1;
          }
  
          //设置参数
          console.log(val.name);
          uploader.setOption("multipart_params", {
            filename: val.name,
            publisher: val.publisher,
            type: val.type,
            upload_date: new Date().toLocaleString(),
            // size:val.size
          });
  
          uploader.settings.multipart_params.size = val.size;
          uploader.settings.multipart_params.id = val.id;
          return val;
        });
      },
      //上传进度回调
      UploadProgress(uploader, file) {
        this.fileList = this.fileList.map((val, ind) => {
          if (val.id == file.id) {
            val.percentage = file.percent;
          }
          return val;
        });
      },
      // 上传成功回调
      FileUploaded(uploader, file, responseObject) {
        this.fileList = this.fileList.map((val, ind) => {
          if (val.id == file.id) {
            // if (JSON.parse(responseObject.response).status == 0) {
            if (status == 0) {
              val.loadType = 2;
            } else {
              val.loadType = 3;
            }
          }
          return val;
        });
      },
      //取消上传回调
      removeFile(id) {
        this.uploader.removeFile(id);
        this.fileList = this.fileList.filter((val, ind) => {
          if (val.id == id) {
            return false;
          } else {
            return true;
          }
        });
      },
      //开始上传
      FileUplodeOn() {
        this.uploader.start();
      },
    },
  };
  </script>
  ```

  

- `AnalysisCloudData.vue`

  ```vue
  <!--
   * @Description: henggao_learning
   * @version: v1.0.0
   * @Author: henggao
   * @Date: 2020-12-21 17:33:53
   * @LastEditors: henggao
   * @LastEditTime: 2020-12-23 11:16:57
  -->
  <template>
    <div class="DataShow">
      <div>
        <h2
          style="
            font-size: 30px;
            padding-top: 10px;
            color: #870000;
            min-width: 500px;
            overflow: hidden;
            text-align: left;
          "
        >
          <i class="el-icon-caret-right" /> 地震元数据信息
        </h2>
      </div>
      <el-container>
        <el-header class="data_search">
          <!--搜索头 开始-->
          <section id="search-title" style="min-width: 500px">
            <el-form
              :inline="true"
              :model="searchCondition"
              class="demo-form-inline"
              @submit.native.prevent
            >
              <el-form-item label="关键字:">
                <el-input
                  v-model="searchCondition.filter_key"
                  suffix-icon="el-icon-view"
                  placeholder="请输入关键字"
                  @keyup.enter.native="onSearchSubmit"
                ></el-input>
              </el-form-item>
              <el-form-item id="submit-item">
                <el-button
                  type="info"
                  plain
                  icon="el-icon-search"
                  @click="onSearchSubmit"
                  >查询</el-button
                >
              </el-form-item>
              <el-form-item id="submit-reset">
                <el-button
                  type="info"
                  plain
                  icon="el-icon-refresh"
                  @click="resetData"
                  >重置</el-button
                >
              </el-form-item>
            </el-form>
          </section>
          <!--搜索头 结束-->
          <!-- <SearchData /> -->
        </el-header>
        <el-main class="data_content">
          <div class="data_table">
            <!-- 注意里面max-height字段设置高度  tableData放列表数据 -->
            <el-table
              class="tb-edit"
              highlight-current-row
              :data="tableData"
              style="width: 100%; overflow: hidden"
              max-height="400px"
              @selection-change="handleSelectionChange"
              lazy
            >
              <!-- 选择框设置 -->
              <el-table-column type="selection" width="50"> </el-table-column>
              <template v-for="col in cols">
                <!-- 设置排序字段 -->
                <el-table-column
                  :key="col._id"
                  :prop="col.prop"
                  sortable
                  :label="col.label"
                  align="center"
                >
                  <!-- 每一行数据 -->
                  <template slot-scope="scope">
                    <div v-if="!scope.row.isEdit">{{ scope.row[col.prop] }}</div>
                    <div v-else>
                      <el-input v-model="scope.row[col.prop]"></el-input>
                    </div>
                  </template>
                </el-table-column>
              </template>
  
              <el-table-column label="下载进度" style="text-align: center">
                <h2>防止按钮消失</h2>
                <template slot-scope="scope">
                  <!-- {{ scope.row["progressNum"] }} -->
                  <!-- <div v-show="progressFlag" class="head-img"> -->
                  <el-progress
                    type="circle"
                    :percentage="scope.row['progressNum']"
                  ></el-progress>
                  <!-- </div> -->
                </template>
              </el-table-column>
              <el-table-column
                label="下载文件"
                class="details"
                width="100"
                style="text-align: center"
              >
                <h2>防止按钮消失</h2>
                <template slot-scope="scope">
                  <el-button
                    type="primary"
                    plain
                    size="mini"
                    @click="downloadfile(scope.$index, scope.row, scope.row)"
                    >下载文件</el-button
                  >
                </template>
              </el-table-column>
            </el-table>
          </div>
          <!-- 分页 -->
          <div class="block" style="overflow: hidden; text-align: center">
            <el-pagination
              small
              @size-change="handleSizeChange"
              @current-change="handleCurrentChange"
              :current-page.sync="currentPage"
              :page-sizes="pageSizes"
              :page-size="PageSize"
              layout="total, sizes, prev, pager, next, jumper"
              :total="totalCount"
            >
            </el-pagination>
          </div>
          <!-- 下面这个用来设置点击添加按钮的弹出框，里面可以进行嵌套表格来展示弹出的表格信息,使用下面的:visible.sync来控制显示与否。里面绑定的是我们新设置的值，填写完成后，将我们这个新值塞到页面中所有的数据当中去  -->
          <!-- 添加数据的对话框 -->
          <el-dialog
            title="添加数据"
            :visible.sync="dialogVisible"
            width="30%"
            @close="addDialogClosed"
          >
            <!-- 内容的主体区域 -->
            <!--去掉:rules="addFormRules" -->
            <el-form
              ref="addFormRef"
              :model="add_to_data"
              :rules="addFormRules"
              label-width="120px"
            >
              <template v-for="(item, key) of addForm">
                <!-- <el-form-item
                  v-if="key == '_id'"
                  :label="key"
                  :prop="key"
                  :key="key"
                >
                  <el-input v-model="addForm[key]"></el-input>
                </el-form-item> -->
                <el-form-item
                  v-if="key !== 'id' && key !== 'location'"
                  :label="key"
                  :prop="key"
                  :key="key"
                >
                  <el-input v-model="add_to_data[key]"></el-input>
                </el-form-item>
              </template>
            </el-form>
          </el-dialog>
        </el-main>
      </el-container>
    </div>
  </template>
  
  <script>
  import axios from "axios";
  import qs from "qs";
  
  // import SearchData from "@/components/SearchData.vue";
  export default {
    name: "AnalysisCloudData",
    components: {
      // SearchData
    },
    data() {
      // 校验添加信息
      let checkZk_name = (rule, value, callback) => {
        const regZk_name = /^ZK[0-9]{1,6}/;
        // const regKey_word = /^[A-Za-z0-9\u4e00-\u9fa5]{3,}$/;
        if (regZk_name.test(value)) {
          // 验证通过，合法
          return callback();
        }
        // 验证不通过，不合法
        callback(new Error("请输入正确的孔号"));
      };
      // 校验添加信息
      let checkCoordinate_E = (rule, value, callback) => {
        var re = /^[0-9]+.?[0-9]*/; //判断字符串是否为数字
        if (re.test(value)) {
          // 验证通过，合法
          return callback();
        }
        // 验证不通过，不合法
        callback(new Error("请输入正确的参数"));
      };
      // 校验添加信息
      let checkCoordinate_N = (rule, value, callback) => {
        var re = /^[0-9]+.?[0-9]*/; //判断字符串是否为数字
        if (re.test(value)) {
          // 验证通过，合法
          return callback();
        }
        // 验证不通过，不合法
        callback(new Error("请输入正确的参数"));
      };
      // 校验添加信息
      let checkCoordinate_R = (rule, value, callback) => {
        var re = /^[0-9]+.?[0-9]*/; //判断字符串是否为数字
        if (re.test(value)) {
          // 验证通过，合法
          return callback();
        }
        // 验证不通过，不合法
        callback(new Error("请输入正确的参数"));
      };
      // 校验添加信息
      let checkMax_depth = (rule, value, callback) => {
        var re = /^[0-9]+.?[0-9]*/; //判断字符串是否为数字
        if (re.test(value)) {
          // 验证通过，合法
          return callback();
        }
        // 验证不通过，不合法
        callback(new Error("请输入正确的参数"));
      };
      // 校验添加信息
      let checkLocation = (rule, value, callback) => {
        var re = /^[0-9]+.?[0-9]*/; //判断字符串是否为数字
        if (re.test(value)) {
          // 验证通过，合法
          return callback();
        }
        // 验证不通过，不合法
        callback(new Error("请输入正确的参数"));
      };
  
      return {
        // cols prop属性值都是作为 tableData的属性
        cols: [
          { label: "节点编号_id", prop: "_id.$oid", nickname: "normal" },
          { label: "名称nickname", prop: "nickname", nickname: "sort" },
          { label: "类型combat", prop: "combat", nickname: "normal" },
          { label: "状态level", prop: "level", nickname: "normal" },
          { label: "坐标rid", prop: "rid", nickname: "normal" },
        ],
        //   表格数据
        tableData: [
          {
            node: "0051",
            name: " 机库顶",
            type: "UWB",
            status: "正常",
            coordinate: "12.21,34.45,34.6",
          },
          {
            node: "0061",
            name: "机库门",
            type: "GPS",
            status: "低电",
            coordinate: "45.41,67.45,78.6",
          },
          {
            node: "0061",
            name: "机库门",
            type: "GPS",
            status: "低电",
            coordinate: "45.41,67.45,78.6",
          },
        ],
        // 筛选字段
        filter_data: [
          { text: "ZK1", value: "ZK1" },
          { text: "ZK2", value: "ZK2" },
          { text: "ZK3", value: "ZK3" },
          { text: "ZK4", value: "ZK4" },
        ],
        // 分页数据，默认第几页
        currentPage: 1,
        // 总条数，根据接口获取数据长度(注意：这里不能为空)
        totalCount: 400,
        // 个数选择器（可修改）
        pageSizes: [10, 20, 50, 100],
        // 默认每页显示的条数（可修改)
        PageSize: 10,
        // 控制添加用户对话框的显示与隐藏，默认为隐藏
        dialogVisible: false,
        // 添加对象表格的字段名
        addForm: {
          zk_name: "",
          coordinate_E: "",
          coordinate_N: "",
          coordinate_R: "",
          max_depth: "",
          track_type: "曲",
          coordinate_lng: "",
          coordinate_lat: "",
          // location: {
          //   type: "Point",
          //   coordinates: [],
          // },
        },
        // 添加数据框的字段,用来判断是否为空，确定按钮
        add_to_data: {
          zk_name: "",
          coordinate_E: "",
          coordinate_N: "",
          coordinate_R: "",
          max_depth: "",
          track_type: "曲",
          coordinate_lng: "",
          coordinate_lat: "",
          // location: {
          //   type: "Point",
          //   coordinates: [],
          // },
        },
        // 通过add_button_state值判断确定按钮是否激活
        add_button_state: false,
        // // 添加表单的验证规则对象
        addFormRules: {
          zk_name: [
            { required: true, message: "请输入钻孔号", trigger: "blur" },
            { min: 3, max: 10, message: "数据格式为'ZK1'", trigger: "blur" },
            { validator: checkZk_name, trigger: "blur" },
          ],
          coordinate_E: [
            { required: true, message: "请输入参数", trigger: "blur" },
            { validator: checkCoordinate_E, trigger: "blur" },
          ],
          coordinate_N: [
            { required: true, message: "请输入参数", trigger: "blur" },
            { validator: checkCoordinate_N, trigger: "blur" },
          ],
          coordinate_R: [
            { required: true, message: "请输入参数", trigger: "blur" },
            { validator: checkCoordinate_R, trigger: "blur" },
          ],
          max_depth: [
            { required: true, message: "请输入参数", trigger: "blur" },
            { validator: checkMax_depth, trigger: "blur" },
          ],
          track_type: [
            { required: true, message: "请输入参数", trigger: "blur" },
          ],
          coordinate_lng: [
            { required: true, message: "请输入参数", trigger: "blur" },
            { validator: checkMax_depth, trigger: "blur" },
          ],
          coordinate_lat: [
            { required: true, message: "请输入参数", trigger: "blur" },
            { validator: checkMax_depth, trigger: "blur" },
          ],
          location: [{ required: true, message: "请输入参数", trigger: "blur" }],
        },
        // 搜索对象
        searchCondition: {
          filter_key: "",
          Depth: "",
          _id: "",
        },
        // 用于判断是否点击过搜索按钮
        flag: false,
        //   下载进度提示
        startTimer: "",
        fresh: false, // 组件加载
        progressFlag: true, //进度条初始值隐藏
        progressNum: 0, //进度条初始值
        //   进度条使用
        ws: null, //websocket通信
      };
    },
    watch: {
      add_to_data: {
        handler(curval, oldval) {
          // console.log(Object.keys(curval)[0]);
          let regZk_name = /^ZK[0-9]{1,6}/;
          let re = /^[0-9]+.?[0-9]*/; //判断字符串是否为数字
          if (
            regZk_name.test(curval.zk_name) &&
            re.test(curval.coordinate_E) &&
            re.test(curval.coordinate_N) &&
            re.test(curval.coordinate_R) &&
            re.test(curval.max_depth) &&
            curval.track_type != "" &&
            re.test(curval.coordinate_lng) &&
            re.test(curval.coordinate_lat)
          ) {
            this.add_button_state = true;
          } else {
            this.add_button_state = false;
          }
        },
        deep: true,
      },
    },
    created() {
      this.showData(this.PageSize, this.currentPage); //展示Collection表格数据
      // this.onSearchSubmit(this.PageSize, this.currentPage); //展示Collection表格数据
    },
    mounted() {},
    methods: {
      // 展示数据,将页码及每页显示的条数以参数传递提交给后台
      showData(n1, n2) {
        const url = "http://127.0.0.1:8000/seismic/seismicinfo/";
        axios
          .get(url, {
            params: {
              // 每页显示的条数
              PageSize: n1,
              // 显示第几页
              currentPage: n2,
            },
          })
          .then((response) => {
            // var res = JSON.parse(response.bodyText);
            // console.log(response);
            //   console.log(response.data);
            //   console.log(response.data.data);
  
            this.tableData = response.data.data.list;
            //   console.log(response.data.data.list);
  
            this.totalCount = response.data.data.count; //分页总数
  
            let tmp = this.tableData[0];
            // console.log(tmp);
            // var listcol = [];
  
            // cols prop属性值都是作为 tableData的属性
            var newcols = [
              { label: "文件名称", prop: "seismic_filename" },
              { label: "研究区域", prop: "location" },
              // { label: "项目名称", prop: "project_name" },
              // { label: "单位名称", prop: "company_name" },
              // { label: "上传人员", prop: "uploader" },
              // { label: "上传时间", prop: "seismic_upload_date" },
              // { label: "钻孔柱状图", prop: "zk_histogram" },
            ];
  
            this.cols = newcols;
            let tem_list = [];
            for (let i = 0; i < 55; i++) {
              // const element = array[i];
              let ZK = "ZK";
              let ZKX = ZK + i;
              // {text:"ZKX",value;"ZKX"}
              let json_data = { text: ZKX, value: ZKX };
              tem_list.push(json_data);
            }
            // console.log(tem_list);
            this.filter_data = tem_list;
          });
      },
  
      // 重置Collection表格数据
      resetData() {
        (this.flag = false), this.showData(10, 1);
      },
      // 选择框
      handleSelectionChange(val) {
        this.multipleSelection = val;
      },
      // 排序
      filterHandler(value, row, column) {
        const property = column["property"];
        return row[property] === value;
      },
      // 监听添加对话框的关闭事件
      addDialogClosed() {
        this.$refs.addFormRef.resetFields();
      },
      // 上传
      uploadSeismicData() {
        this.$router.push({ path: "/mongeostore/seismicupload" });
      },
      // 下载
      downloadfile(index, row, row_data) {
        //   console.log(id);
        this.WebSocketTest(index, row, row_data);
      },
      // 编辑（修改）按钮
      handleEdit(index, row) {
        // console.log(index, row);
        // 动态设置数据并通过这个数据判断显示方式
        if (row.isEdit) {
          // 点击保存的
          this.$delete(row, "isEdit");
          // console.log("开始delete");
          // console.log(index, row); //把row发送给后端
          // console.log(row["_id"]["$oid"]); //把row发送给后端
          // row["id"] = row["_id"]["$oid"];
          // row["help_param"] = "help_param"; //用于解决后端smscode参数为3019"}多了"}问题
          // let postData = qs.stringify(row); // w为了解决后端拿不到数据问题
          // postData["_id"] = row["_id"]["$oid"];
          // console.log(typeof postData);
          // console.log(row["id"]);
          let json_data = JSON.stringify(row);
  
          const url = "http://127.0.0.1:8000/seismic/editseismicinfo/";
          axios
            .post(
              url,
              {
                // data: JSON.stringify(row) //data用于post请求
                json_data,
                // 设置上传到后端的数据库和集合名称
                colname: this.$store.state.title_message,
                dbname: this.$store.state.temp_database,
              },
              {
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
              }
              // console.log(postData)
            )
            .then((res) => {
              console.log("编辑成功");
              console.log(res.data);
              if (res.data == 412) {
                // 输入有误,后端返回状态码,进行提示
                this.$message.error("输入时间有误,请重新编辑!");
              }
            })
            .catch((err) => {
              console.log("输入有误");
            });
        } else {
          // 点击编辑
          this.$set(row, "isEdit", true);
          // console.log("开始set");
          // console.log(index, row);
        }
        // console.log(this.tableData);s
      },
      // 删除按钮
      deleteRow(index, rows, row) {
        // 添加确认删除框
        this.$confirm("永久删除，是否继续？", "提示", {
          confirmButtonText: "确定",
          cancelButtonText: "取消",
          type: "warning",
        })
          .then(() => {
            // 删除操作
            rows.splice(index, 1);
            let json_data = JSON.stringify(row);
            console.log(json_data);
            const url = "http://127.0.0.1:8000/seismic/deleteseismicinfo/";
            axios
              .post(
                url,
                {
                  json_data,
                  // 设置上传到后端的数据库和集合名称
                  colname: this.$store.state.title_message,
                  dbname: this.$store.state.temp_database,
                },
                {
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                }
              )
              .then((res) => {
                console.log("删除成功");
                // 重新获取用户列表数据
                // this.showData();
                //通过flag判断,刷新数据
                if (!this.flag) {
                  this.showData(this.PageSize, this.currentPage);
                } else {
                  this.onSearchSubmit(this.PageSize, this.currentPage);
                }
              });
          })
          .catch(() => {
            this.$message({
              type: "info",
              message: "取消删除",
            });
          });
      },
      // 开始搜索
      onSearchSubmit(n1, n2) {
        this.currentPage = n2;
        // this.initAdminList(1);
        if (this.searchCondition.filter_key == "") {
          this.$message.warning("查询条件不能为空！");
          return;
        } else {
          // console.log(this.searchCondition.filter_key);
          // console.log(this.$store.state.temp_database);
          let filter_key_data = this.searchCondition.filter_key;
          const url = "http://127.0.0.1:8000/seismic/seismicinfosearch/";
          axios
            .get(url, {
              params: {
                // 每页显示的条数
                PageSize: n1,
                // 显示第几页
                currentPage: n2,
                // 搜索字段
                search_key: filter_key_data,
              },
            })
            .then((response) => {
              if (response.data.data.list) {
                this.tableData = response.data.data.list; //返回查询的数据
  
                this.totalCount = response.data.data.count; //搜索后分页总数;
              } else {
                // alert("输入有误或数据不存在");
                this.$message.warning("输入有误或数据不存在");
                return;
              }
              //页面初始化数据需要判断是否检索过
              this.flag = true;
            });
        }
      },
  
      handleDelete(index, row) {
        console.log(index, row);
      },
      // 分页
      // 每页显示的条数
      handleSizeChange(val) {
        console.log(`每页 ${val} 条`);
        // 改变每页显示的条数
        this.PageSize = val;
        // 点击每页显示的条数时，显示第一页
        // this.showData(val, 1);
        if (!this.flag) {
          this.showData(val, 1); // this.pageSize是undefined，使用选定的或默认值
        } else {
          this.onSearchSubmit(val, 1);
        }
        // 注意：在改变每页显示的条数时，要将页码显示到第一页
        this.currentPage = 1;
        // this.handleCurrentChange(this.currentPage);
      },
      // 监听 pageSize 改变的事件，显示第几页
      handleCurrentChange(val) {
        console.log(`当前页: ${val}`);
        // 改变默认的页数
        this.currentPage = val;
  
        if (!this.flag) {
          this.showData(this.PageSize, val); // this.pageSize是undefined，使用选定的或默认值
        } else {
          this.onSearchSubmit(this.pageSize, val);
        }
      },
      // 进度条
      WebSocketTest(index, row, row_data) {
        if ("WebSocket" in window) {
          // alert("您的浏览器支持 WebSocket!");
          if (this.ws) {
            this.ws.close();
          }
  
          // 打开一个 web socket
          let ws = new WebSocket(
            "ws://127.0.0.1:8000/seismic/analysisclouddown/"
          );
          // 给后端发数据
          ws.onopen = function () {
            // Web Socket 已连接上，使用 send() 方法发送数据
            //   ws.send("发送数据");
            ws.send(row.id);
            //   alert("数据发送中...");
          };
          // 接收数据
          var that = this;
          ws.onmessage = function (evt) {
            var received_msg = evt.data;
            //   alert("数据已接收...");
            //   alert("数据:" + received_msg);
            var json_data = eval("(" + received_msg + ")");
            console.log(json_data["percent"]);
            //   this.progressNum = json_data["percent"];
            //   temp_data = {};
            //   console.log(index, row);
            this.progressNum = 0 + json_data["percent"];
            row.progressNum = 0 + this.progressNum;
            row = {
              id: row_data.id,
              seismic_filename: row_data.seismic_filename,
              location: row_data.location,
              progressNum: this.progressNum,
            };
            console.log(row);
          //   console.log(this);
          //   console.log(that);
            that.tableData = [row];
            //   return row;
            //   this.$set(this.tableData, index, row);
            //   this.$set(this.tableData,index,temp_data)
            //   this.fresh = false;
            //   this.$nextTick(() => {
            //     this.fresh = true;
            //   });
            //   this.startTimer = setInterval(() => {
            //     this.progressNum++;
            //     if (this.progressNum > 85) {
            //       clearInterval(this.startTimer);
            //     }
            //   }, 100);
            //   console.log(this.progressNum);
            if (json_data["percent"] == 100) {
              console.log("完成");
              ws.close(); //关闭websocket
            }
          };
          // Call onopen directly if socket is already open
          if (ws.readyState == WebSocket.OPEN) ws.onopen();
          // this.ws = ws;
        } else {
          // 浏览器不支持 WebSocket
          alert("您的浏览器不支持 WebSocket!");
        }
      },
    },
  };
  </script>
  
  <style>
  /* 全局样式 */
  </style>
  <style lang="scss" scoped>
  /* 本地样式 */
  // 设置真个数据内容的大小
  // .DataShow {
  //   // height: 775px;
  //   // height: 810px;
  // }
  // 设置搜索框的大小
  .data_search {
    height: 45px !important;
  }
  // 设置表格数据大小，表格+分页
  // .data_content {
  //   // height: 680px !important;
  //   // overflow: auto;
  // }
  // 设置表格数据大小
  .data_table {
    height: 400px !important; //注意这个高度和table中max-height="620px"对应,避免部分内容展示不出来
    //   overflow: auto;
  }
  // 搜索设置
  #search-title {
    padding-top: 2px;
    height: 45px;
    float: right;
  }
  // 设置搜索关键字段字体
  .demo-form-inline ::v-deep .el-form-item__label {
    font-size: 18px !important;
    color: rgb(73, 76, 80);
    font-family: "Arial Narrow";
    font-weight: bold;
  }
  // 设置表格数据滚动条,这里还是留着比较好
  .block {
    padding-top: 15px;
  }
  // .el-scrollbar__wrap {
  //   overflow-x: hidden; //设置滚动条隐藏
  // }
  
  ::v-deep .el-progress-circle {
    height: 40px !important;
    width: 40px !important;
  }
  ::v-deep .el-progress__text {
    //   width: 5px !important;
    font-size: 1px !important;
  }
  ::v-deep .cell {
    text-align: center;
  }
  </style>
  ```





 



  

