# é¡¹ç›®

[TOC]

## 1. åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹

- åœ¨ç›®å½•`/usr/local`ä¸‹åˆ›å»º

```
mkdir wjproject_docker
```

![](IMG/å¾®ä¿¡æˆªå›¾_20210704155555.png)

## 2. åˆ›å»ºDocker compose

- åœ¨`wjproject_docker`ç›®å½•ä¸‹åˆ›å»º`compose`

  ```
  mkdir compose
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210704171840.png)



## 3. åˆ›å»º`Django`é¡¹ç›®

### 3.1 Djangoé¡¹ç›®è™šæ‹Ÿç¯å¢ƒ

- å®‰è£…è™šæ‹Ÿç¯å¢ƒ

  ```
  pip install virtualenv
  pip install virtualenvwrapper
  ```


- è¿›å…¥`wjproject_docker`ç›®å½•ï¼Œåˆ›å»ºDjangoè™šæ‹Ÿç¯å¢ƒ

  ```
   virtualenv wjproject_env
  ```

- åˆ‡æ¢åˆ°è™šæ‹Ÿç¯å¢ƒç›®å½•ï¼Œæ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

  ```shell
  # åˆ‡æ¢åˆ°è™šæ‹Ÿç¯å¢ƒç›®å½•
  cd wjproject_env
  
  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
  source bin/activate
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705093755.png)

- åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…Django

  ```shell
  pip install django
  
  # å¯ä»¥æŒ‡å®šDjangoç‰ˆæœ¬å®‰è£…
  pip install django==2.2
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705093939.png)

- æ£€æŸ¥ Django ç‰ˆæœ¬ï¼š

  ```
  django-admin --version
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705094122.png)

- è‹¥æƒ³åˆ‡æ¢ä¸ºæ­£å¸¸çš„ç”¨æˆ·ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„å‘½ä»¤ï¼š

  ```
  deactivate
  ```



### 3.2 Djangoé¡¹ç›®

- åœ¨è™šæ‹Ÿç¯å¢ƒä¸‹`wjprojectç›®å½•ä¸‹åˆ›å»º`Djangoé¡¹ç›®ï¼Œæ³¨æ„æ·»åŠ æœ€å`.`

  ```shell
   # è¡¥å……,æœ€å¥½åŠ ä¸ªç‚¹ï¼Œä¸ç„¶ä¼šå¤šåˆ›å»ºä¸€å±‚ç›®å½•
  django-admin startproject wjproject .
  ```

  ```txt
  é¡¹ç›®ç›®å½•è¯´æ˜ï¼š
  
  __init__.py: è¯´æ˜test1æ˜¯ä¸€ä¸ªpythonåŒ…ã€‚
  
  settings.py: é¡¹ç›®çš„é…ç½®æ–‡ä»¶ã€‚
  
  urls.py: è¿›è¡Œurlè·¯ç”±çš„é…ç½®ã€‚
  
  wsgi.py:  webæœåŠ¡å™¨å’ŒDjangoäº¤äº’çš„å…¥å£ã€‚
  
  manage.py:  é¡¹ç›®çš„ç®¡ç†æ–‡ä»¶ã€‚
  ```

- è¿è¡Œ

  ```
  python manage.py runserver
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705095231.png)

- æµè§ˆå™¨è®¿é—®

![](IMG/å¾®ä¿¡æˆªå›¾_20210705095347.png)

- `ctrl+c`ç»“æŸ
- å‘½ä»¤deactivateé€€å‡ºè™šæ‹Ÿç¯å¢ƒ



### 3.3 åˆ›å»ºåº”ç”¨APP

```
python manage.py startapp wjproject_app
```

â€‹	![](IMG/å¾®ä¿¡æˆªå›¾_20210705095733.png)

- è¿è¡Œ

  ```shell
  #è¿ç§»æ•°æ®
  python3 manage.py migrate
  
  #è¿è¡Œé¡¹ç›®
  python3 manage.py runserver
  ```

- æµè§ˆå™¨è®¿é—®ç«¯å£



- åˆ›å»ºApp

  ```shell
   python3 manage.py startapp wjproject_app01
  ```


- é¡¹ç›®ç»“æ„å›¾

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705095904.png)

- [ref](https://xie.infoq.cn/article/9cf95edc8810abe6a61625c0c)





## 4. åˆ›å»ºVueé¡¹ç›®

### 4.1 ç¯å¢ƒå®‰è£…

- å®‰è£…`Nodejs`

  ```
  # å®‰è£…
  sudo apt install nodejs
  
  # æŸ¥çœ‹nodejsç‰ˆæœ¬
  nodejs -v
  ```

  - v10.19.0

    ![](IMG/å¾®ä¿¡æˆªå›¾_20210705103332.png)

- å®‰è£…`npm`

  ```
  # å®‰è£…
  sudo apt install npm
  
  # æŸ¥çœ‹ç‰ˆæœ¬
  npm -v
  ```

  - 6.14.4

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705103230.png)

- å®‰è£…æ·˜å®`NPM`é•œåƒ`cnpm`,ä¸ºå®‰è£…æ‰©å±•æå‡é€Ÿåº¦

  ```
  #å®‰è£…
  sudo npm install -g cnpm --registry=https://registry.npm.taobao.org
  
  #æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ,æˆåŠŸä¼šæœ‰ç‰ˆæœ¬å·è¾“å‡º
  cnpm -v  
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705103609.png)

- å®‰è£…`vue`è„šæ‰‹æ¶å·¥å…·`vue-cli`

  - å®‰è£…`Vue2.0`

    ```
    # å®‰è£…ï¼Œè¿™ç§å®‰è£…ç›®å‰åªèƒ½å®‰è£…vueç‰ˆæœ¬2.9.6
    sudo cnpm install -g vue-cli
    
    # å¸è½½
    npm uninstall vue-cli -g
    
    #æŸ¥çœ‹ç‰ˆæœ¬å·
    vue -V
    ```

    

  - å®‰è£…`vue3.0`

    ```
    å®‰è£…
    npm install @vue/cli -g
    
    #æŸ¥çœ‹ç‰ˆæœ¬å·
    vue -V
    ```

    ![](IMG/å¾®ä¿¡æˆªå›¾_20210705104518.png)

- Tips:âœ¨å»ºè®®è¿˜æ˜¯ä½¿ç”¨`npm`å®‰è£…ï¼Œ`cnpm`å¯èƒ½ä¼šæœ‰æ„å¤–~

- 

### 4.2 Vueé¡¹ç›®æ„å»º

- åˆ›å»ºVue3.0é¡¹ç›®

```
vue create wjproject_ui
```

![](IMG/å¾®ä¿¡æˆªå›¾_20210705111042.png)

- åˆ‡æ¢åˆ°`wjproject_ui`ç›®å½•ï¼Œè¿è¡ŒVueé¡¹ç›®

  ```
  npm run serve
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705111318.png)

- æµè§ˆå™¨æŸ¥çœ‹

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705111401.png)





## 5. å®‰è£…`MongoDB`

- å®‰è£…

  ```shell
  # ç›®å‰å®‰è£…mongodb3.6.8ï¼Œå®‰è£…ç‰ˆæœ€æ–°éœ€è¦é…ç½®ï¼Œç¨å¾®å¤æ‚ç‚¹
  sudo apt install mongodb -y
  ```

- è¾“å…¥`mongo`å³å¯è¿›å…¥æ•°æ®åº“

  ```shell
  # å¯åŠ¨ mongodb æœåŠ¡
  service mongodb start
  
  # å…³é—­ mongodb æœåŠ¡
  service mongodb stop
  
  # é‡å¯ mongodb æœåŠ¡
  service mongodb restart
  ```

  



## 6. æ‰“åŒ…éƒ¨ç½²æµ‹è¯•

- **Tips**ğŸˆï¼šå†™åœ¨å‰é¢ï¼ŒECSæœåŠ¡å™¨æœ‰å®‰å…¨è§„åˆ™ï¼Œéœ€è¦å¼€æ”¾ï¼Œè§6.3

### 6.1 åç«¯é¡¹ç›®

#### 1. åç«¯é¡¹ç›®`uWSGI`é…ç½®

- `uWSGI`é…ç½®ï¼Œåœ¨Djangoæ ¹ç›®å½•`/wjproject_docker/wjproject_env`ä¸‹æ–°å»º`wjproject_uwsgi.ini`æ–‡ä»¶ï¼Œè¾“å…¥é…ç½®ä¿¡æ¯

  ```ini
  [uwsgi]
  ; ç›‘å¬çš„ç«¯å£,ä¸é…ç½®nginx
  ; http = :8001
  #é…ç½®ç«¯å£å·,æŒ‡å®šå’Œnginxè¿›è¡Œå¥—æ¥å­—é€šä¿¡çš„æ–¹å¼ï¼šç«¯å£æˆ–æ–‡ä»¶
  socket= 127.0.0.1:8000
  ; socket= 39.105.175.144:8000
  ; socket= 0.0.0.0:8002
  #é¡¹ç›®çš„ç»å¯¹è·¯å¾„,é¡¹ç›®æ‰€åœ¨ç›®å½•ï¼Œå’Œmanage.pyåŒçº§
  chdir=/usr/local/wjproject_docker/wjproject_env
  
  ; ä¸»åº”ç”¨ä¸­çš„wsgiæ–‡ä»¶
  wsgi-file = wjproject_v1/wsgi.py
  
  ; å¯åŠ¨ä¸€ä¸ªmasterè¿›ç¨‹ï¼Œæ¥ç®¡ç†å…¶ä½™çš„å­è¿›ç¨‹
  master=true
  #è®¾ç½®æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°
  processes=4
  threads = 2
  
  #ä¿å­˜ä¸»è¿›ç¨‹çš„pidï¼Œç”¨æ¥æ§åˆ¶uwsgiæœåŠ¡
  pidfile=/usr/local/wjproject_docker/wjproject_env/logs/uwsgi.pid
  
  ; è®¾ç½®åå°è¿è¡Œï¼Œä¿å­˜æ—¥å¿—
  daemonize=/usr/local/wjproject_docker/wjproject_env/logs/uwsgi.log
  
  ; è®¾ç½®æ¯ä¸ªå·¥ä½œè¿›ç¨‹å¤„ç†è¯·æ±‚çš„ä¸Šé™ï¼Œè¾¾åˆ°ä¸Šé™æ—¶ï¼Œå°†å›æ”¶ï¼ˆé‡å¯ï¼‰è¯¥è¿›ç¨‹ã€‚å¯ä»¥é¢„é˜²å†…å­˜æ³„æ¼
  max-requests=5000
  
  #æœåŠ¡åœæ­¢æ—¶è‡ªåŠ¨ç§»é™¤unix Socketå’Œpidæ–‡ä»¶
  vacuum=true
  
  # æŒ‡å®šä¾èµ–çš„è™šæ‹Ÿç¯å¢ƒ
  ; virtualenv=/home/peter/.virtualenvs/opwfenv
  virtualenv=/usr/local/wjproject_docker/wjproject_env
  ```
  
  - æ³¨æ„ï¼šä¸ºäº†é…åˆ `nginx` å·¥ä½œï¼Œç«¯å£åè®®æ˜¯ socket , å¦‚æœæ¢æˆ `http` ,åˆ™å¯ä»¥ç›´æ¥è¿è¡Œ`uwsgi`ï¼Œå°±èƒ½é€šè¿‡æµè§ˆå™¨è®¿é—®é¡µé¢äº†ã€‚å‘½ä»¤ä¸º `uwsgi dj_uwsgi.ini`ã€‚



#### 2.`Django`é¡¹ç›®éƒ¨ç½²åœ¨é˜¿é‡Œäº‘å‡†å¤‡

- `settings.py`è®¾ç½®

  - ç¬¬ä¸€å¤„ï¼š`DEBUG = True`éœ€è¦æ”¹ä¸º`DEBUG = False`

  ```python
  DEBUG = False
  
  ALLOWED_HOSTS = ['æœåŠ¡å™¨å…¬ç½‘IP']
  
  ```

  - ç¬¬äºŒå¤„

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705205733.png)

  - ç¬¬ä¸‰å¤„ï¼š

  ```python
  # Add for vuejs
  STATICFILES_DIRS = [  # æ·»åŠ é™æ€æ–‡ä»¶è·¯å¾„
      os.path.join(BASE_DIR, "wjproject_ui/static"),
  ]
  # è®¾ç½®æ”¶é›†é™æ€èµ„æºçš„è·¯å¾„(éƒ¨ç½²æ—¶ä½¿ç”¨)
  STATIC_ROOT = BASE_DIR
  ```

  

- `urls.py`è®¾ç½®

  ```python
  from django.views.generic import TemplateView
  
  urlpatterns = [
      path('admin/', admin.site.urls),
      path('',TemplateView.as_view(template_name="index.html")),
  ]
  
  ```

  

### 6.2 å‰ç«¯é¡¹ç›®

- å‰ç«¯é¡¹ç›®æ‰“åŒ…

  - è¿›å…¥å‰ç«¯é¡¹ç›®ç›®å½•ï¼Œåˆ‡æ¢åˆ°`wjproject_ui`ç›®å½•ï¼Œè¿è¡Œæ‰“åŒ…

  ```
  npm run build
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705141424.png)

- `Nginx`éƒ¨ç½²ï¼Œåœ¨006ä¸­å·²ç»å®‰è£…å¥½

- é…ç½®`Nginx`çš„é…ç½®æ–‡ä»¶ï¼Œç›®çš„æ˜¯å°†`nginx`å’Œ`uWSGI`æœåŠ¡å™¨å®ç°é€šä¿¡è¿æ¥ã€‚åœ¨`/etc/nginx/conf.d`æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ›å»º`wjproject.conf`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

  ```conf
  server {
     listen   8001;      
     server_name  39.105.175.144;
     charset     utf-8;
     client_max_body_size  75M;
     
     location /media {        
         expires 30d;
         autoindex  on;
         add_header Cache-Control private;
         alias /usr/local/wjproject_docker/wjproject_env/media/;
      }
      location /static {      
          expires 30d;
          autoindex on;
          add_header Cache-Control private;
          alias /usr/local/wjproject_docker/wjproject_env/wjproject_ui/dist/static;
       }
       location / {          
           include  uwsgi_params;
           uwsgi_pass 127.0.0.1:8000;
           uwsgi_read_timeout 2;
        }
  }
  
  server {
  	 listen 8004; 
  	 server_name 39.105.175.144; 
  	 location / {
  	 root /usr/local/wjproject_docker/wjproject_env/wjproject_ui/dist; 
  	 try_files $uri $uri/ /index.html; 
  	 }
   }
  ```
  
- ç¬¬ä¸€ä¸ªserveré…ç½®ä¿¡æ¯æ˜¯å°†`nginx`å’Œ`uWSGI`æœåŠ¡å™¨å®ç°é€šä¿¡è¿æ¥ï¼›
  
  - ```
      uwsgi_pass 127.0.0.1:8002; //å¿…é¡»å’Œuwsgiä¸­socketçš„è®¾ç½®ä¸€è‡´
      ```
  
- ç¬¬äºŒä¸ªserveræ˜¯é…ç½®Vueé¡¹ç›®
  
- å®Œæˆä¸Šè¿°æ–‡ä»¶é…ç½®åï¼Œé‡å¯`nginx`æ–‡ä»¶ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

  ```
  service nginx reload
  ```

  

- è¿è¡Œ`wjproject_uwsgi.ini`æ–‡ä»¶ï¼Œåœ¨é¡¹ç›®ç›®å½•`/wjproject_env`ä¸‹ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨`wjproject_uwsgi.ini`æ–‡ä»¶ï¼š

  ```bash
  #å¯åŠ¨
  uwsgi --ini wjproject_uwsgi.ini
  # åœæ­¢
  uwsgi --stop logs/uwsgi.pid
  pkill -f uwsgi -9
  ```

- æŸ¥çœ‹è¿›ç¨‹

  ```
  ps -ef |grep uwsgi
  ```

  ![](IMG/å¾®ä¿¡æˆªå›¾_20210705164534.png)

- æ‰“å¼€æœ¬åœ°æµè§ˆå™¨ï¼Œè®¿é—®æˆåŠŸã€‚

```bash
http://39.105.175.144:8004
```

![](IMG/å¾®ä¿¡æˆªå›¾_20210705205320.png)

- **Tipsï¼š**åœ¨LINUXä¸‹éƒ¨ç½²`Nginx`ã€`uwsgi`ã€`django`æ—¶ï¼Œå‡ºç°é—®é¢˜`uwsgi`å¯åŠ¨å¤ªå¤šæ¬¡ï¼š

```
sudo fuser -k 8080/tcp
```

- [ref](https://blog.csdn.net/weixin_44623662/article/details/109607897)

- [ref2](https://www.cnblogs.com/joy99/p/9034253.html)

- [ref3](https://www.cnblogs.com/wurijie/p/12950322.html)

  

### 6.3 é˜¿é‡Œäº‘éƒ¨ç½²

- ECSæœåŠ¡å™¨ä¸Šæ­å»ºçš„djangoé¡¹ç›®é€šè¿‡å…¬ç½‘ipå’Œç«¯å£å·è®¿é—®ï¼Œéœ€è¦æ·»åŠ å¼€å‘è§„åˆ™ã€‚

- äº‘æœåŠ¡å™¨ECSä¸‹çš„ã€å®ä¾‹ã€‘,å•å‡»ã€æ›´å¤šã€‘æŒ‰é’®ï¼Œé€‰æ‹©ã€ ç½‘ç»œå’Œå®‰å…¨ç»„ã€‘-->ã€å®‰å…¨ç»„é…ç½®ã€‘

![](IMG/å¾®ä¿¡æˆªå›¾_20210705200650.png)

- å•å‡»ã€é…ç½®è§„åˆ™ã€‘-->ã€æ‰‹åŠ¨æ·»åŠ ã€‘

![](IMG/å¾®ä¿¡æˆªå›¾_20210705200939.png)



- [ref](https://www.jianshu.com/p/d6c64c892424)



## Djangoåç«¯é¡¹ç›®é…ç½®å¼€æœºè‡ªå¯åŠ¨

